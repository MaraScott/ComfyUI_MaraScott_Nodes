var t=Object.defineProperty,e=(e,a,s)=>((e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s)(e,"symbol"!=typeof a?a+"":a,s);window.marascott||(window.marascott={}),window.marascott.McBoaty_v5||(window.marascott.McBoaty_v5={init:!1,clean:!1,params:{denoise:{values:[]}},message:{prompts:[],tiles:[],denoises:[]},inputs:{prompts:[],tiles:[],denoises:[]}});const a={validateDenoiseValue:t=>{if(""===t)return!0;const e=parseFloat(t);return!isNaN(e)&&e>=0&&e<=1},formatDenoiseValue:t=>{if(""===t)return t;let e=t.toString();return e.startsWith(".")&&(e="0"+e),parseFloat(e).toFixed(2)},WRAPPER:(t,e,s,n,o,l)=>{const r=document.createElement("div");r.className="comfy-wrapper-mcboaty";const d=document.createElement("div");d.style.height="100%",d.style.display="flex",d.style.alignItems="center",d.style.gap="10px";const c=document.createElement("p");c.textContent=String(e+1).padStart(2,"0");const u=document.createElement("textarea");u.style.opacity=.6,u.style.flexGrow=1,u.style.height="100%",u.className="comfy-multiline-input",u.value=s||"",u.placeholder="tile "+c.textContent,u.dataId="tile "+e,u.dataNodeId=l.id,u.addEventListener("focusout",async function(){if(this.value=this.value.trim(),window.marascott.McBoaty_v5.message.prompts[e]!=this.value){window.marascott.McBoaty_v5.message.prompts[e]=this.value,await(await fetch(`/MaraScott/McBoaty/v5/set_prompt?index=${e}&prompt=${encodeURIComponent(this.value)}&node=${this.dataNodeId}&clientId=${window.api.clientId}`)).json();const t=i.getByName(l,"requeue");t&&i.setValue(l,"requeue",++t.value)}});const p=document.createElement("input");p.style.opacity=.6,p.style.height="100%",p.style.maxWidth="1.8rem",p.style.flexShrink="0",p.className="comfy-multiline-input",p.value=o||"",p.placeholder="denoise "+c.textContent,p.dataId="tile "+e,p.dataNodeId=l.id,p.addEventListener("focusout",async function(){if(this.value=this.value.trim(),a.validateDenoiseValue(this.value)?this.value=a.formatDenoiseValue(this.value):this.value="",window.marascott.McBoaty_v5.message.denoises[e]!=this.value){window.marascott.McBoaty_v5.message.denoises[e]=this.value,await(await fetch(`/MaraScott/McBoaty/v5/set_denoise?index=${e}&denoise=${encodeURIComponent(this.value)}&node=${this.dataNodeId}&clientId=${window.api.clientId}`)).json();const t=i.getByName(l,"requeue");t&&i.setValue(l,"requeue",++t.value)}});const m=document.createElement("img");var h;m.src=(h=n,window.api.apiURL(`/view?filename=${encodeURIComponent(h.filename)}&type=${h.type}&subfolder=${h.subfolder}${window.app.getPreviewFormatParam()}${window.app.getRandParam()}`)),m.alt=s,m.style.height="100%",m.style.maxWidth="128px",m.style.maxHeight="128px",m.style.flexShrink="0",d.appendChild(c),d.appendChild(m),d.appendChild(u),d.appendChild(p),r.appendChild(d);const v=l.addDOMWidget(t,"customtext",r,{getValue:()=>r.value,setValue(t){r.value=t}});return v.inputEl=r,i.setValue(l,v.name,s),u.addEventListener("input",()=>{var t;null==(t=v.callback)||t.call(v,v.value)}),v}};class s{static async clean(t){window.marascott.McBoaty_v5.clean=!1;const e=t.title;t.title=e+" ... cleaned";const a=await(await fetch(`/MaraScott/McBoaty/v5/get_input_prompts?node=${t.id}`)).json(),s=await(await fetch(`/MaraScott/McBoaty/v5/get_input_denoises?node=${t.id}`)).json();window.marascott.McBoaty_v5.message.prompts=window.marascott.McBoaty_v5.inputs.prompts=a.prompts_in,window.marascott.McBoaty_v5.inputs.denoises=window.marascott.McBoaty_v5.message.denoises=s.denoises_in,window.marascott.McBoaty_v5.message.tiles=window.marascott.McBoaty_v5.inputs.tiles,i.setValue(t,i.INDEX.name,i.INDEX.default),i.setValue(t,i.PROMPT.name,i.PROMPT.default),i.setValue(t,i.DENOISE.name,i.DENOISE.default),i.setValue(t,"requeue",0),t.widgets=t.widgets.filter(e=>{const a=new Event("focusout");if("customtext"==e.type){const s=e.inputEl.querySelector('[placeholder^="tile "]');if(null!=s){const n=s.getAttribute("placeholder"),o=parseInt(n.replace("tile ",""),10)-1,l=window.marascott.McBoaty_v5.inputs.prompts[o];i.setValue(t,e.name,l),s.value=l,s.dispatchEvent(a)}}return!0}),i.refresh(t),setTimeout(()=>{t.title=e},500)}}class i{static refresh(t){var e,a;t.widgets=t.widgets.filter(t=>{var e,a;return"customtext"==t.type?(null==(e=t.onRemove)||e.call(t),!1):t.name!==this.CLEAN.name||(null==(a=t.onRemove)||a.call(t),!1)}),this.setIndexInput(t),this.setPromptInput(t),this.setDenoiseInput(t),null==(e=t.onResize)||e.call(t,t.size),t.graph.setDirtyCanvas(!0,!0),this.setPrompterInputs(t),this.setCleanSwitch(t),null==(a=t.onResize)||a.call(t,t.size),t.graph.setDirtyCanvas(!0,!0)}static init(t){this.setIndexInput(t),this.setPromptInput(t),this.setDenoiseInput(t),this.setCleanSwitch(t)}static getByName(t,e){var a;return null==(a=t.widgets)?void 0:a.find(t=>t.name===e)}static setValue(t,e,a){var s;const i=this.getByName(t,e);i&&(i.value=a,t.setProperty(e,null!=(s=i.value)?s:t.properties[e]),t.setDirtyCanvas(!0))}static setIndexInput(t){null==this.getByName(t,this.INDEX.name)&&(t.addWidget("text",this.INDEX.name,this.INDEX.default,e=>{this.setValue(t,this.INDEX.name,e),this.setValue(t,this.PROMPT.name,this.PROMPT.default),this.setValue(t,this.DENOISE.name,this.DENOISE.default),this.refresh(t)},{}),this.setValue(t,this.INDEX.name,this.INDEX.default))}static setPromptInput(t){null==this.getByName(t,this.PROMPT.name)&&(t.addWidget("text",this.PROMPT.name,this.PROMPT.default,e=>{var a;this.setValue(t,this.PROMPT.name,e);const s=null!=(a=t.properties[this.INDEX.name])?a:this.INDEX.default;t.widgets=t.widgets.filter(t=>{const a=new Event("focusout"),i=s.split(",").map(t=>Number(t)-1);if("customtext"==t.type){const n=t.inputEl.querySelector('[placeholder^="tile "]');if(null!=n){const t=n.getAttribute("placeholder"),o=parseInt(t.replace("tile ",""),10)-1,l=i.indexOf(o);(""!=s&&l>-1||""==s)&&(n.value=e,n.dispatchEvent(a))}}return!0}),this.setValue(t,this.PROMPT.name,this.PROMPT.default)},{}),this.setValue(t,this.PROMPT.name,this.PROMPT.default))}static setDenoiseInput(t){null==this.getByName(t,this.DENOISE.name)&&(t.addWidget("combo",this.DENOISE.name,this.DENOISE.default,e=>{var a;if(this.setValue(t,this.DENOISE.name,e),"unchanged"!=e){"Use Global Denoise"==e&&(e="");const s=null!=(a=t.properties[this.INDEX.name])?a:this.INDEX.default;t.widgets=t.widgets.filter(t=>{const a=new Event("focusout"),i=s.split(",").map(t=>Number(t)-1);if("customtext"==t.type){const n=t.inputEl.querySelector('[placeholder^="denoise "]');if(null!=n){const t=n.getAttribute("placeholder"),o=parseInt(t.replace("denoise ",""),10)-1,l=i.indexOf(o);(""!=s&&l>-1||""==s)&&(n.value=e,n.dispatchEvent(a))}}return!0}),this.setValue(t,this.DENOISE.name,this.DENOISE.default)}},{values:window.marascott.McBoaty_v5.params.denoise.values}),this.setValue(t,this.DENOISE.name,this.DENOISE.default))}static setCleanSwitch(t){null==this.getByName(t,this.CLEAN.name)&&(t.addWidget("toggle",this.CLEAN.name,this.CLEAN.default,()=>{this.setValue(t,this.CLEAN.name,this.CLEAN.default),s.clean(t)},{}),this.setValue(t,this.CLEAN.name,this.CLEAN.default))}static setPrompterInputs(t){var e;let s=(null!=(e=t.properties[this.INDEX.name])?e:this.INDEX.default).trim().split(",");s=1===s.length&&""===s[0]?[]:s;const i=s.map(t=>Number(t)-1);for(const[n]of window.marascott.McBoaty_v5.message.prompts.entries())(0==s.length||i.indexOf(n)>-1)&&a.WRAPPER("tile "+n,n,window.marascott.McBoaty_v5.message.prompts[n],window.marascott.McBoaty_v5.message.tiles[n],window.marascott.McBoaty_v5.message.denoises[n],t)}}e(i,"INDEX",{name:"Filter by Indexes",default:""}),e(i,"PROMPT",{name:"Prompt",default:""}),e(i,"DENOISE",{name:"Denoise",values:["unchanged","Use Global Denoise"],default:"unchanged",min:0,max:1,step:.01}),e(i,"CLEAN",{name:"Reset",default:!1}),window.marascott.McBoaty_v5.params.denoise.values=i.DENOISE.values.slice();for(let l=i.DENOISE.min;l<=i.DENOISE.max;l=parseFloat((l+i.DENOISE.step).toFixed(2)))window.marascott.McBoaty_v5.params.denoise.values.push(l.toFixed(2));class n{constructor(t,e){window.__McBoaty_v5__||(window.__McBoaty_v5__=Symbol("__McBoaty_v5__")),this.symbol=window.__McBoaty_v5__,this.api=t||window.api,this.app=e||window.app}getState(t){return t[this.symbol]||{}}setState(t,e){var a,s,i;t[this.symbol]=e,null==(i=(null==(a=this.app)?void 0:a.canvas)||(null==(s=window.app)?void 0:s.canvas))||i.setDirty(!0)}addStatusTagHandler(t){var e;if(null==(e=t[this.symbol])?void 0:e.statusTagHandler)return;t[this.symbol]||(t[this.symbol]={}),t[this.symbol]={statusTagHandler:!0},this.api.addEventListener("MaraScott/McBoaty_v5/update_status",({detail:t})=>{let{node:e,progress:a,text:s}=t;const i=window.app.graph.getNodeById(+(e||window.app.runningNodeId));if(!i)return;const n=this.getState(i);n.status=Object.assign(n.status||{},{progress:s?a:null,text:s||null}),this.setState(i,n)});const a=this,s=t.prototype.onDrawForeground;t.prototype.onDrawForeground=function(t){var e,i;const n=null==(e=null==s?void 0:s.apply)?void 0:e.call(s,this,arguments),o=a.getState(this);if(!(null==(i=null==o?void 0:o.status)?void 0:i.text))return n;const{fgColor:l,bgColor:r,text:d,progress:c,progressColor:u}={...o.status};t.save(),t.font="12px sans-serif";const p=t.measureText(d);return t.fillStyle=r||"dodgerblue",t.beginPath(),t.roundRect(0,-LiteGraph.NODE_TITLE_HEIGHT-20,p.width+12,20,5),t.fill(),c&&(t.fillStyle=u||"green",t.beginPath(),t.roundRect(0,-LiteGraph.NODE_TITLE_HEIGHT-20,(p.width+12)*c,20,5),t.fill()),t.fillStyle=l||"#fff",t.fillText(d,6,-LiteGraph.NODE_TITLE_HEIGHT-6),t.restore(),n}}}const o=t=>({name:"ComfyUI.MaraScott.McBoaty_v5",async beforeRegisterNodeDef(e,a,s){if(new n(t,s).addStatusTagHandler(e),"MaraScottMcBoatyTilePrompter_v5"===a.name){const t=e.prototype.onExecuted;e.prototype.onExecuted=function(e){var a;const s=null==(a=null==t?void 0:t.apply)?void 0:a.call(t,this,arguments);return window.marascott.McBoaty_v5.inputs.prompts=e.prompts_in||[],window.marascott.McBoaty_v5.message.prompts=e.prompts_out||[],window.marascott.McBoaty_v5.inputs.denoises=e.denoises_in||[],window.marascott.McBoaty_v5.message.denoises=e.denoises_out||[],window.marascott.McBoaty_v5.inputs.tiles=window.marascott.McBoaty_v5.message.tiles=e.tiles||[],i.refresh(this),s};const a=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){var t;const e=a?a.apply(this,arguments):void 0;return this.widgets=this.widgets.filter(t=>{var e,a,s;return!(null==(a=null==(e=t.name)?void 0:e.startsWith)?void 0:a.call(e,"tile "))||(null==(s=t.onRemove)||s.call(t),!1)}),i.init(this),null==(t=this.onResize)||t.call(this,this.size),e}}else{const a=e.prototype.getExtraMenuOptions;e.prototype.getExtraMenuOptions=function(e,s){var i;const n=null==(i=null==a?void 0:a.apply)?void 0:i.call(a,this,arguments);let o;if(null!=this.imageIndex?o=this.imgs[this.imageIndex]:null!=this.overIndex&&(o=this.imgs[this.overIndex]),o){let e=s.findIndex(t=>"Save Image"===t.content);-1===e?e=0:e++,s.splice(e,0,{content:"TilePrompt (McBoaty)",callback:async()=>{let e=o.src;e=e.replace("/view?",`/MaraScott/McBoaty_v5/tile_prompt?node=${this.id}&clientId=${t.clientId}&`);const a=await(await fetch(e)).json();alert(a)}})}return n}}}});export{o as MaraScottMcBoaty_v5,a as McBoatyWidgets};
