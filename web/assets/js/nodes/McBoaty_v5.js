var E=Object.defineProperty;var I=(r,t,a)=>t in r?E(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;var f=(r,t,a)=>I(r,typeof t!="symbol"?t+"":t,a);window.marascott||(window.marascott={});window.marascott.McBoaty_v5||(window.marascott.McBoaty_v5={init:!1,clean:!1,params:{denoise:{values:[]}},message:{prompts:[],tiles:[],denoises:[]},inputs:{prompts:[],tiles:[],denoises:[]}});function _(r){return window.api.apiURL(`/view?filename=${encodeURIComponent(r.filename)}&type=${r.type}&subfolder=${r.subfolder}${window.app.getPreviewFormatParam()}${window.app.getRandParam()}`)}const y={validateDenoiseValue:r=>{if(r==="")return!0;const t=parseFloat(r);return!isNaN(t)&&t>=0&&t<=1},formatDenoiseValue:r=>{if(r==="")return r;let t=r.toString();return t.startsWith(".")&&(t="0"+t),parseFloat(t).toFixed(2)},WRAPPER:(r,t,a,i,n,e)=>{const u=document.createElement("div");u.className="comfy-wrapper-mcboaty";const o=document.createElement("div");o.style.height="100%",o.style.display="flex",o.style.alignItems="center",o.style.gap="10px";const p=document.createElement("p");p.textContent=String(t+1).padStart(2,"0");const s=document.createElement("textarea");s.style.opacity=.6,s.style.flexGrow=1,s.style.height="100%",s.className="comfy-multiline-input",s.value=a||"",s.placeholder="tile "+p.textContent,s.dataId="tile "+t,s.dataNodeId=e.id,s.addEventListener("focusout",async function(){if(this.value=this.value.trim(),window.marascott.McBoaty_v5.message.prompts[t]!=this.value){window.marascott.McBoaty_v5.message.prompts[t]=this.value,await(await fetch(`/MaraScott/McBoaty/v5/set_prompt?index=${t}&prompt=${encodeURIComponent(this.value)}&node=${this.dataNodeId}&clientId=${window.api.clientId}`)).json();const h=c.getByName(e,"requeue");h&&c.setValue(e,"requeue",++h.value)}});const l=document.createElement("input");l.style.opacity=.6,l.style.height="100%",l.style.maxWidth="1.8rem",l.style.flexShrink="0",l.className="comfy-multiline-input",l.value=n||"",l.placeholder="denoise "+p.textContent,l.dataId="tile "+t,l.dataNodeId=e.id,l.addEventListener("focusout",async function(){if(this.value=this.value.trim(),y.validateDenoiseValue(this.value)?this.value=y.formatDenoiseValue(this.value):this.value="",window.marascott.McBoaty_v5.message.denoises[t]!=this.value){window.marascott.McBoaty_v5.message.denoises[t]=this.value,await(await fetch(`/MaraScott/McBoaty/v5/set_denoise?index=${t}&denoise=${encodeURIComponent(this.value)}&node=${this.dataNodeId}&clientId=${window.api.clientId}`)).json();const h=c.getByName(e,"requeue");h&&c.setValue(e,"requeue",++h.value)}});const d=document.createElement("img");d.src=_(i),d.alt=a,d.style.height="100%",d.style.maxWidth="128px",d.style.maxHeight="128px",d.style.flexShrink="0",o.appendChild(p),o.appendChild(d),o.appendChild(s),o.appendChild(l),u.appendChild(o);const m=e.addDOMWidget(r,"customtext",u,{getValue(){return u.value},setValue(h){u.value=h}});return m.inputEl=u,c.setValue(e,m.name,a),s.addEventListener("input",()=>{var h;(h=m.callback)==null||h.call(m,m.value)}),m}};class g{static async clean(t){window.marascott.McBoaty_v5.clean=!1;const a=" ... cleaned",i=t.title;t.title=i+a;const n=await(await fetch(`/MaraScott/McBoaty/v5/get_input_prompts?node=${t.id}`)).json(),e=await(await fetch(`/MaraScott/McBoaty/v5/get_input_denoises?node=${t.id}`)).json();window.marascott.McBoaty_v5.message.prompts=window.marascott.McBoaty_v5.inputs.prompts=n.prompts_in,window.marascott.McBoaty_v5.inputs.denoises=window.marascott.McBoaty_v5.message.denoises=e.denoises_in,window.marascott.McBoaty_v5.message.tiles=window.marascott.McBoaty_v5.inputs.tiles,c.setValue(t,c.INDEX.name,c.INDEX.default),c.setValue(t,c.PROMPT.name,c.PROMPT.default),c.setValue(t,c.DENOISE.name,c.DENOISE.default),c.setValue(t,"requeue",0),t.widgets=t.widgets.filter(u=>{const o=new Event("focusout");if(u.type=="customtext"){const p=u.inputEl.querySelector('[placeholder^="tile "]');if(p!=null){const s=p.getAttribute("placeholder"),d=parseInt(s.replace("tile ",""),10)-1,m=window.marascott.McBoaty_v5.inputs.prompts[d];c.setValue(t,u.name,m),p.value=m,p.dispatchEvent(o)}}return!0}),c.refresh(t),setTimeout(()=>{t.title=i},500)}}class c{static refresh(t){var a,i;t.widgets=t.widgets.filter(n=>{var e,u;return n.type=="customtext"?((e=n.onRemove)==null||e.call(n),!1):n.name===this.CLEAN.name?((u=n.onRemove)==null||u.call(n),!1):!0}),this.setIndexInput(t),this.setPromptInput(t),this.setDenoiseInput(t),(a=t.onResize)==null||a.call(t,t.size),t.graph.setDirtyCanvas(!0,!0),this.setPrompterInputs(t),this.setCleanSwitch(t),(i=t.onResize)==null||i.call(t,t.size),t.graph.setDirtyCanvas(!0,!0)}static init(t){this.setIndexInput(t),this.setPromptInput(t),this.setDenoiseInput(t),this.setCleanSwitch(t)}static getByName(t,a){var i;return(i=t.widgets)==null?void 0:i.find(n=>n.name===a)}static setValue(t,a,i){var e;const n=this.getByName(t,a);n&&(n.value=i,t.setProperty(a,(e=n.value)!=null?e:t.properties[a]),t.setDirtyCanvas(!0))}static setIndexInput(t){this.getByName(t,this.INDEX.name)==null&&(t.addWidget("text",this.INDEX.name,this.INDEX.default,i=>{this.setValue(t,this.INDEX.name,i),this.setValue(t,this.PROMPT.name,this.PROMPT.default),this.setValue(t,this.DENOISE.name,this.DENOISE.default),this.refresh(t)},{}),this.setValue(t,this.INDEX.name,this.INDEX.default))}static setPromptInput(t){this.getByName(t,this.PROMPT.name)==null&&(t.addWidget("text",this.PROMPT.name,this.PROMPT.default,i=>{var e;this.setValue(t,this.PROMPT.name,i);const n=(e=t.properties[this.INDEX.name])!=null?e:this.INDEX.default;t.widgets=t.widgets.filter(u=>{const o=new Event("focusout"),p=n.split(",").map(s=>Number(s)-1);if(u.type=="customtext"){const s=u.inputEl.querySelector('[placeholder^="tile "]');if(s!=null){const l=s.getAttribute("placeholder"),m=parseInt(l.replace("tile ",""),10)-1,h=p.indexOf(m);(n!=""&&h>-1||n=="")&&(s.value=i,s.dispatchEvent(o))}}return!0}),this.setValue(t,this.PROMPT.name,this.PROMPT.default)},{}),this.setValue(t,this.PROMPT.name,this.PROMPT.default))}static setDenoiseInput(t){this.getByName(t,this.DENOISE.name)==null&&(t.addWidget("combo",this.DENOISE.name,this.DENOISE.default,i=>{var n;if(this.setValue(t,this.DENOISE.name,i),i!="unchanged"){i=="Use Global Denoise"&&(i="");const e=(n=t.properties[this.INDEX.name])!=null?n:this.INDEX.default;t.widgets=t.widgets.filter(u=>{const o=new Event("focusout"),p=e.split(",").map(s=>Number(s)-1);if(u.type=="customtext"){const s=u.inputEl.querySelector('[placeholder^="denoise "]');if(s!=null){const l=s.getAttribute("placeholder"),m=parseInt(l.replace("denoise ",""),10)-1,h=p.indexOf(m);(e!=""&&h>-1||e=="")&&(s.value=i,s.dispatchEvent(o))}}return!0}),this.setValue(t,this.DENOISE.name,this.DENOISE.default)}},{values:window.marascott.McBoaty_v5.params.denoise.values}),this.setValue(t,this.DENOISE.name,this.DENOISE.default))}static setCleanSwitch(t){this.getByName(t,this.CLEAN.name)==null&&(t.addWidget("toggle",this.CLEAN.name,this.CLEAN.default,()=>{this.setValue(t,this.CLEAN.name,this.CLEAN.default),g.clean(t)},{}),this.setValue(t,this.CLEAN.name,this.CLEAN.default))}static setPrompterInputs(t){var n;let a=((n=t.properties[this.INDEX.name])!=null?n:this.INDEX.default).trim().split(",");a=a.length===1&&a[0]===""?[]:a;const i=a.map(e=>Number(e)-1);for(const[e]of window.marascott.McBoaty_v5.message.prompts.entries())(a.length==0||i.indexOf(e)>-1)&&y.WRAPPER("tile "+e,e,window.marascott.McBoaty_v5.message.prompts[e],window.marascott.McBoaty_v5.message.tiles[e],window.marascott.McBoaty_v5.message.denoises[e],t)}}f(c,"INDEX",{name:"Filter by Indexes",default:""}),f(c,"PROMPT",{name:"Prompt",default:""}),f(c,"DENOISE",{name:"Denoise",values:["unchanged","Use Global Denoise"],default:"unchanged",min:0,max:1,step:.01}),f(c,"CLEAN",{name:"Reset",default:!1});window.marascott.McBoaty_v5.params.denoise.values=c.DENOISE.values.slice();for(let r=c.DENOISE.min;r<=c.DENOISE.max;r=parseFloat((r+c.DENOISE.step).toFixed(2)))window.marascott.McBoaty_v5.params.denoise.values.push(r.toFixed(2));class N{constructor(t,a){window.__McBoaty_v5__||(window.__McBoaty_v5__=Symbol("__McBoaty_v5__")),this.symbol=window.__McBoaty_v5__,this.api=t||window.api,this.app=a||window.app}getState(t){return t[this.symbol]||{}}setState(t,a){var i,n,e;t[this.symbol]=a,(e=((i=this.app)==null?void 0:i.canvas)||((n=window.app)==null?void 0:n.canvas))==null||e.setDirty(!0)}addStatusTagHandler(t){var n;if((n=t[this.symbol])!=null&&n.statusTagHandler)return;t[this.symbol]||(t[this.symbol]={}),t[this.symbol]={statusTagHandler:!0},this.api.addEventListener("MaraScott/McBoaty_v5/update_status",({detail:e})=>{let{node:u,progress:o,text:p}=e;const s=window.app.graph.getNodeById(+(u||window.app.runningNodeId));if(!s)return;const l=this.getState(s);l.status=Object.assign(l.status||{},{progress:p?o:null,text:p||null}),this.setState(s,l)});const a=this,i=t.prototype.onDrawForeground;t.prototype.onDrawForeground=function(e){var v,w;const u=(v=i==null?void 0:i.apply)==null?void 0:v.call(i,this,arguments),o=a.getState(this);if(!((w=o==null?void 0:o.status)!=null&&w.text))return u;const{fgColor:p,bgColor:s,text:l,progress:d,progressColor:m}={...o.status};e.save(),e.font="12px sans-serif";const h=e.measureText(l);return e.fillStyle=s||"dodgerblue",e.beginPath(),e.roundRect(0,-LiteGraph.NODE_TITLE_HEIGHT-20,h.width+12,20,5),e.fill(),d&&(e.fillStyle=m||"green",e.beginPath(),e.roundRect(0,-LiteGraph.NODE_TITLE_HEIGHT-20,(h.width+12)*d,20,5),e.fill()),e.fillStyle=p||"#fff",e.fillText(l,6,-LiteGraph.NODE_TITLE_HEIGHT-6),e.restore(),u}}}const B=r=>({name:"ComfyUI.MaraScott.McBoaty_v5",async beforeRegisterNodeDef(t,a,i){if(new N(r,i).addStatusTagHandler(t),a.name==="MaraScottMcBoatyTilePrompter_v5"){const e=t.prototype.onExecuted;t.prototype.onExecuted=function(o){var s;const p=(s=e==null?void 0:e.apply)==null?void 0:s.call(e,this,arguments);return window.marascott.McBoaty_v5.inputs.prompts=o.prompts_in||[],window.marascott.McBoaty_v5.message.prompts=o.prompts_out||[],window.marascott.McBoaty_v5.inputs.denoises=o.denoises_in||[],window.marascott.McBoaty_v5.message.denoises=o.denoises_out||[],window.marascott.McBoaty_v5.inputs.tiles=window.marascott.McBoaty_v5.message.tiles=o.tiles||[],c.refresh(this),p};const u=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){var p;const o=u?u.apply(this,arguments):void 0;return this.widgets=this.widgets.filter(s=>{var l,d,m;return(d=(l=s.name)==null?void 0:l.startsWith)!=null&&d.call(l,"tile ")?((m=s.onRemove)==null||m.call(s),!1):!0}),c.init(this),(p=this.onResize)==null||p.call(this,this.size),o}}else{const e=t.prototype.getExtraMenuOptions;t.prototype.getExtraMenuOptions=function(u,o){var l;const p=(l=e==null?void 0:e.apply)==null?void 0:l.call(e,this,arguments);let s;if(this.imageIndex!=null?s=this.imgs[this.imageIndex]:this.overIndex!=null&&(s=this.imgs[this.overIndex]),s){let d=o.findIndex(m=>m.content==="Save Image");d===-1?d=0:d++,o.splice(d,0,{content:"TilePrompt (McBoaty)",callback:async()=>{let m=s.src;m=m.replace("/view?",`/MaraScott/McBoaty_v5/tile_prompt?node=${this.id}&clientId=${r.clientId}&`);const h=await(await fetch(m)).json();alert(h)}})}return p}}}});export{B as MaraScottMcBoaty_v5,y as McBoatyWidgets};
