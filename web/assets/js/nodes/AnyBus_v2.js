var t=Object.defineProperty,e=(e,n,l)=>((e,n,l)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l)(e,"symbol"!=typeof n?n+"":n,l);async function n(){if(!(globalThis.React&&globalThis.ReactDOM||(await l("https://unpkg.com/react@18.3.1/umd/react.production.min.js"),await l("https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"),globalThis.React&&globalThis.ReactDOM)))throw new Error("React UMD not loaded")}function l(t){return new Promise((e,n)=>{const l=document.createElement("script");l.src=t,l.async=!0,l.onload=e,l.onerror=()=>n(new Error("Failed to load "+t)),document.head.appendChild(l)})}function a(t,e){if(!t.__ms_mount){const e=document.createElement("div");(t.attachShadow?t.attachShadow({mode:"open"}):t).appendChild(e),t.__ms_mount={container:e,root:globalThis.ReactDOM.createRoot(e)}}t.__ms_mount.root.render(e)}function i(t,e){var n,l,a;const i=null==t?void 0:t.links;return i?function(t){return t&&"function"==typeof t.get&&"function"==typeof t.values}(i)?null!=(n=i.get(e))?n:null:Array.isArray(i)?null!=(l=i.find(t=>t&&t.id===e))?l:null:null!=(a=i[e])?a:null:null}function o(){try{window.dispatchEvent(new CustomEvent("marascott:anybus:changed"))}catch{}}window.marascott||(window.marascott={}),window.marascott.AnyBus_v2?(window.marascott.AnyBus_v2.flows={start:[],list:[],end:[]},window.marascott.AnyBus_v2.nodes={}):window.marascott.AnyBus_v2={init:!1,sync:0,input:{label:"0",index:0},clean:!1,nodeToSync:null,flows:{start:[],list:[],end:[]},nodes:{},__syncing:!1};const s="MaraScottAnyBus_v2";function r(t){var e;const n=null==(e=t.inputs)?void 0:e[E.BUS_SLOT];if(!n||null==n.link)return null;const l=i(t.graph,n.link);return l?t.graph.getNodeById(l.origin_id):null}function u(t){var e,n;const l=null==(e=t.outputs)?void 0:e[E.BUS_SLOT],a=[];if(!(null==(n=null==l?void 0:l.links)?void 0:n.length))return a;for(const o of l.links){const e=i(t.graph,o);if(!e)continue;const n=t.graph.getNodeById(e.target_id);(null==n?void 0:n.type)===s&&a.push(n)}return a}function c(t){var e,n,l,a,i,o;const s=null!=(null==(n=null==(e=t.inputs)?void 0:e[E.BUS_SLOT])?void 0:n.link),r=(null!=(o=null==(i=null==(a=null==(l=t.outputs)?void 0:l[E.BUS_SLOT])?void 0:a.links)?void 0:i.length)?o:0)>0;return!(!s&&!r)}function d(t){if(!c(t))return null;const e=function(t){const e=new Set,n=[t],l=[];for(;n.length;){const t=n.shift();if(!t||e.has(t.id))continue;e.add(t.id),l.push(t);const a=r(t);(null==a?void 0:a.type)===s&&n.push(a);for(const e of u(t))n.push(e)}return l}(t);return e.length>1?e:null}function p(t,e){if(!t.length)return[];const n=new Set(t.map(t=>t.id)),l=t.filter(t=>!function(t,e){const n=r(t);return n&&e.has(n.id)?n:null}(t,n)),a=[];function i(t,e){const l=function(t,e){return u(t).filter(t=>e.has(t.id))}(t,n);if(l.length)for(const n of l)e.includes(n)?a.push([...e,t]):i(n,[...e,t]);else a.push([...e,t])}return l.length?l.forEach(t=>i(t,[])):i(t[0],[]),a}function h(t){var e,n;const l=[],a=E.FIRST_INDEX,i=null!=(n=null==(e=t.inputs)?void 0:e.length)?n:0;for(let o=a;o<i;o++){const e=t.inputs[o];e&&l.push({slot:o,name:e.name,type:e.type,linked:null!=e.link})}return l}function m(t,e,n){var l,a,o;const s=null==(a=null==(l=null==n?void 0:n.inputs)?void 0:l[E.BUS_SLOT])?void 0:a.link,r=null!=s?i(t,s):null;return r&&r.origin_id===e.id&&r.origin_slot===E.BUS_SLOT?{id:r.id,valid:!0}:{id:null!=(o=null==r?void 0:r.id)?o:null,valid:!1}}function g(t){var e,n,l,a,i,o;if(!(null==t?void 0:t.graph)||window.marascott.AnyBus_v2.__syncing)return;const s=d(t);if(s){window.marascott.AnyBus_v2.__syncing=!0;try{const r=null!=(n=null==(e=t.properties)?void 0:e[T.PROFILE.name])?n:T.PROFILE.default,u=null!=(a=null==(l=t.properties)?void 0:l[T.INPUTS.name])?a:T.INPUTS.default;for(const t of s)T.setValue(t,T.PROFILE.name,r,!0),(null==(i=t.properties)?void 0:i[T.INPUTS.name])!==u&&T.setValue(t,T.INPUTS.name,u,!0);for(const t of s)null==(o=t.setDirtyCanvas)||o.call(t,!0,!0)}finally{window.marascott.AnyBus_v2.__syncing=!1}}}function f(t){return"string"==typeof t&&/^\*\s*\d+/.test(t.trim())}function v(t){var e,n,l,a;if(!(null==t?void 0:t.graph))return;const i=d(t);if(!i)return;const o=function(t){const e=new Map(t.map(t=>[t.id,t])),n=t.filter(t=>!r(t)),l=[];function a(t,n){const i=u(t);if(i.length&&!i.every(t=>!e.has(t.id)))for(const l of i)e.has(l.id)&&(n.includes(l.id)||a(l,[...n,t.id]));else l.push([...n,t.id])}if(n.length)for(const i of n)a(i,[]);else for(const i of t)a(i,[]);return l.map(t=>t.map(t=>e.get(t)))}(i);if(!o.length)return;const s=Math.max(...i.map(t=>{var e,n;return null!=(n=null==(e=t.properties)?void 0:e[T.INPUTS.name])?n:T.INPUTS.default}));for(let r=E.FIRST_INDEX;r<=s;r++){let t=null;for(const n of o){let l=null,a=null;for(let i=0;i<n.length;i++){const o=null==(e=n[i].inputs)?void 0:e[r];if(o&&(!l&&o.type&&"*"!==o.type?(l=o.type,o.name&&!f(o.name)&&(a=o.name)):l?o.type===l&&o.name&&!f(o.name)&&o.name!==a&&(a=o.name):o.name&&!f(o.name)&&(a=null!=a?a:o.name),l&&a)){const e={type:l,label:a,depth:i};(!t||e.depth>t.depth)&&(t=e)}}}if(t)for(const e of i){const a=null==(n=e.inputs)?void 0:n[r],i=null==(l=e.outputs)?void 0:l[r];a&&i&&(a.name=t.label,"*"!==a.type&&a.type!==t.type||(a.type=t.type),i.name=a.name,i.links&&i.links.length>0&&i.type!==t.type&&"*"!==i.type||(i.type=t.type))}}for(const r of i)null==(a=r.setDirtyCanvas)||a.call(r,!0,!0)}const T={NAMESPACE:"MaraScott",TYPE:"AnyBus_v2",BUS_SLOT:0,FIRST_INDEX:1,ALLOWED_REROUTE_TYPE:["Reroute (rgthree)"].slice(),ALLOWED_GETSET_TYPE:["SetNode","GetNode"].slice(),ALLOWED_NODE_TYPE:[],PROFILE:{name:"profile",default:"default"},INPUTS:{name:"inputs",min:2,max:24,default:2},CLEAN:{name:"Clean Inputs",default:!1},init(t){var e,n;t.properties=t.properties||{},t.properties[this.PROFILE.name]=null!=(e=t.properties[this.PROFILE.name])?e:this.PROFILE.default,t.properties[this.INPUTS.name]=null!=(n=t.properties[this.INPUTS.name])?n:this.INPUTS.default,t.properties.prevProfileName=t.properties[this.PROFILE.name],t.shape=LiteGraph.CARD_SHAPE,t.color=LGraphCanvas.node_colors.green.color,t.bgcolor=LGraphCanvas.node_colors.green.bgcolor,t.groupcolor=LGraphCanvas.node_colors.green.groupcolor,t.size[0]=150,this.updateNodeTitle(t)},updateNodeTitle(t){t.title="AnyBus - "+t.properties[this.PROFILE.name]},getByName(t,e){var n;return null==(n=t.widgets)?void 0:n.find(t=>t.name===e)},setWidgetValue(t,e,n){var l;const a=this.getByName(t,e);a&&(a.value=n,null==(l=t.setDirtyCanvas)||l.call(t,!0,!0))},updateNodeIO(t){if(!t.graph)return;const e=t.properties[this.INPUTS.name],n=(t.inputs||[]).map((e,n)=>{if(null!=(null==e?void 0:e.link)){const l=i(t.graph,e.link);if(l)return{idx:n,link:l}}return null}).filter(Boolean);t.inputs=[],t.outputs=[],t.addInput("bus","BUS"),t.addOutput("bus","BUS");for(let l=1;l<=e;l++){const e=`* ${l.toString().padStart(2,"0")}`.toLowerCase();t.addInput(e,"*"),t.addOutput(e,"*")}n.forEach(({idx:e,link:n})=>{const l=t.graph.getNodeById(n.origin_id);l&&t.connect(e,l,n.origin_slot)}),t.setDirtyCanvas(!0)},setWidgets(t){const e=(e,n)=>{var l;const a=null==(l=t.widgets)?void 0:l.find(t=>t.name===e);a&&(a.value=n)};if(this.getByName(t,this.PROFILE.name)?e(this.PROFILE.name,t.properties[this.PROFILE.name]):t.addWidget("text",this.PROFILE.name,t.properties[this.PROFILE.name],e=>this.setValue(t,this.PROFILE.name,e),{title:"Profile name for this bus"}),this.getByName(t,this.INPUTS.name))e(this.INPUTS.name,t.properties[this.INPUTS.name]);else{const e=Array.from({length:this.INPUTS.max-this.INPUTS.min+1},(t,e)=>e+this.INPUTS.min);t.addWidget("combo",this.INPUTS.name,t.properties[this.INPUTS.name],e=>this.setValue(t,this.INPUTS.name,e),{values:e,title:"Number of input/output pairs"})}this.getByName(t,this.CLEAN.name)||t.addWidget("toggle",this.CLEAN.name,this.CLEAN.default,()=>{try{E.clean(t)}catch(e){}},{title:"Clean and reset all connections"})},setValue(t,e,n,l=!1){var a;const i=t.properties[e];t.properties[e]=n,this.setWidgetValue(t,e,n),e===this.PROFILE.name?(this.updateNodeTitle(t),t.properties.prevProfileName=n):e===this.INPUTS.name&&i!==n&&this.updateNodeIO(t),null==(a=t.setDirtyCanvas)||a.call(t,!0,!0),l||c(t)&&(g(t),v(t)),o()}};T.ALLOWED_NODE_TYPE=[T.NAMESPACE+T.TYPE,...T.ALLOWED_REROUTE_TYPE,...T.ALLOWED_GETSET_TYPE];class E{static connectBus(t,e,n,l){var a,i,s,r,u,c,d;const p=T.PROFILE.name,h=null!=(i=null==(a=t.properties)?void 0:a[p])?i:T.PROFILE.default,m=null!=(r=null==(s=n.properties)?void 0:s[p])?r:T.PROFILE.default;if(h!==T.PROFILE.default&&h!==m)return t.disconnectInput(e),null==(u=t.setDirtyCanvas)||u.call(t,!0,!0),void o();h===T.PROFILE.default&&m!==h&&T.setValue(t,p,m);const g=T.INPUTS.name,f=null!=(d=null==(c=n.properties)?void 0:c[g])?d:T.INPUTS.default;T.setValue(t,g,f),v(t),o()}static connectInput(t,e,n,l){var a,i,s,r;const u=null==(a=n.outputs)?void 0:a[l];if(!u)return;const d=(u.name||"").toLowerCase(),p=u.type||"*";(null==(i=t.inputs)?void 0:i[e])&&(t.inputs[e].name=d||`* ${e.toString().padStart(2,"0")}`,t.inputs[e].type=p,(null==(s=t.outputs)?void 0:s[e])&&(t.outputs[e].name=t.inputs[e].name,t.outputs[e].type=p)),null==(r=t.setDirtyCanvas)||r.call(t,!0,!0),c(t)&&v(t),o()}static disConnectBus(t){var e;null==(e=t.setDirtyCanvas)||e.call(t,!0,!0),o()}static disConnectInput(t,e){var n;null==(n=t.setDirtyCanvas)||n.call(t,!0,!0),o()}static clean(t){var e,n,l,a,s;if(!(null==t?void 0:t.graph))return;let r=!1;if(null!=(null==(n=null==(e=t.inputs)?void 0:e[this.BUS_SLOT])?void 0:n.link)){const e=i(t.graph,t.inputs[this.BUS_SLOT].link);if(e){const n=t.graph.getNodeById(e.origin_id);n&&(t.disconnectInput(this.BUS_SLOT),n.connect(this.BUS_SLOT,t,this.BUS_SLOT),r=!0)}}else for(let o=this.FIRST_INDEX;o<(null!=(a=null==(l=t.inputs)?void 0:l.length)?a:0);o++){const e=t.inputs[o];if(e&&null!=e.link){const n=i(t.graph,e.link);if(n){const e=t.graph.getNodeById(n.origin_id);e&&(t.disconnectInput(o),e.connect(n.origin_slot,t,o),r=!0)}}}if(r){const e=" ... cleaned";t.title=t.title+e,null==(s=t.setDirtyCanvas)||s.call(t,!0,!0),setTimeout(()=>{var n;t.title=t.title.replace(e,""),null==(n=t.setDirtyCanvas)||n.call(t,!0,!0)},500),o()}}}e(E,"TYPE",s),e(E,"BUS_SLOT",0),e(E,"FIRST_INDEX",1);const y="Comfy.MaraScott.AnyBus_v2",S=y.replace(/\./g,"-");function b({text:t,kind:e="default"}){const n="warn"===e?"#f59e0b22":"ok"===e?"#16a34a22":"#6b728022",l="warn"===e?"#f59e0b":"ok"===e?"#16a34a":"#6b7280";return globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("span",{style:{display:"inline-block",padding:"2px 8px",marginRight:6,marginBottom:6,fontSize:12,borderRadius:999,background:n,border:"1px solid "+l}},t))}const R=()=>({name:y,aboutPageBadges:[{label:"Website - MaraScott",url:"https://www.marascott.ai/",icon:"pi pi-home"},{label:"Donate - MaraScott",url:"https://github.com/sponsors/MaraScott",icon:"pi pi-heart"},{label:"GitHub - MaraScott",url:"https://github.com/MaraScott/ComfyUI_MaraScott_Nodes",icon:"pi pi-github"}],bottomPanelTabs:[{id:S,title:"MaraScott Flows",type:"custom",render:async t=>{function e(){return globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("div",null,"Mara Scott"))}await n(),t.innerHTML="",a(t,globalThis.React.createElement(e,null))}}],async beforeRegisterNodeDef(t,e,n){if(t.comfyClass===T.NAMESPACE+T.TYPE){const e=t.prototype.onNodeCreated;t.prototype.onNodeCreated=function(){T.init(this),T.setWidgets(this),T.updateNodeIO(this),T.setWidgetValue(this,T.PROFILE.name,this.properties[T.PROFILE.name]),T.setWidgetValue(this,T.INPUTS.name,this.properties[T.INPUTS.name]),null==e||e.apply(this,arguments),this.serialize_widgets=!0,window.marascott.AnyBus_v2.init=!0};const n=t.prototype.onConnectionsChange;t.prototype.onConnectionsChange=function(t,e,l,a,i){var r,u;if(this.graph){if(window.marascott.AnyBus_v2.input.index=e+1-E.FIRST_INDEX,l&&a){const t=this.graph.getNodeById(a.origin_id);t&&(e===E.BUS_SLOT?t.type===s&&a.origin_slot===E.BUS_SLOT?E.connectBus(this,e,t,a.origin_slot):this.disconnectInput(e):E.connectInput(this,e,t,a.origin_slot))}else l||(e===E.BUS_SLOT?E.disConnectBus(this):E.disConnectInput(this,e));e===E.BUS_SLOT&&null!=(null==(u=null==(r=this.inputs)?void 0:r[E.BUS_SLOT])?void 0:u.link)&&g(this),o(),null==n||n.apply(this,arguments)}}}},async setup(){}}),_=()=>({id:S,icon:"mdi mdi-vector-polyline",title:"Any Bus",tooltip:"Any Bus Dashboard",type:"custom",render:async t=>{await n();const e=globalThis.React;function l(){const[t,n]=e.useState({flows:[],totalFlows:0,nodesCount:0,nodes:[],last:0}),l=e.useCallback(()=>{const t=null!=(a=null!=(l=null==(e=globalThis.app)?void 0:e.graph)?l:globalThis.graph)?a:null;var e,l,a;if(!t)return void n({flows:[],total:0,scanned:0,last:Date.now()});const i=function(t){var e,n,l;const a=(null!=(e=null==t?void 0:t._nodes)?e:[]).filter(t=>(null==t?void 0:t.type)===s),i=new Map;for(const o of a){const t=null!=(l=null==(n=null==o?void 0:o.properties)?void 0:n[T.PROFILE.name])?l:T.PROFILE.default;i.has(t)||i.set(t,[]),i.get(t).push(o)}return i}(t),o=[];let r=0;for(const[n,s]of i.entries()){r+=s.length;const e=p(s).map((e,n)=>{const l=[];for(let i=0;i<e.length-1;i++){const n=m(t,e[i],e[i+1]);l.push({from:e[i],to:e[i+1],linkId:n.id,valid:n.valid})}const a={};for(const t of e)a[t.id]=h(t);return{nodes:e,edges:l,slotSummaries:a,index:n+1}});o.push({profile:n,count:e.length,chains:e})}n({flows:o,total:o.length,scanned:r,last:Date.now()})},[]);return e.useEffect(()=>{const t=()=>l();return window.addEventListener("marascott:anybus:changed",t),()=>window.removeEventListener("marascott:anybus:changed",t)},[l]),globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("div",null,globalThis.React.createElement("div",null,globalThis.React.createElement("strong",null,"AnyBus Flows"),globalThis.React.createElement(b,{text:`${t.total} flow(s)`,kind:t.total?"ok":"warn"}),globalThis.React.createElement(b,{text:`${t.scanned} node(s)`}),globalThis.React.createElement("div",null),globalThis.React.createElement("button",{onClick:l,style:{padding:"2px 8px",cursor:"pointer"}},"Refresh")),t.flows.map(t=>globalThis.React.createElement("details",{key:t.profile,open:!0},globalThis.React.createElement("summary",null,globalThis.React.createElement("span",null,"Profile: "),globalThis.React.createElement("strong",null,t.profile)," ",globalThis.React.createElement(b,{text:`${t.count} chain(s)`})),t.chains.map(n=>globalThis.React.createElement("div",{key:t.profile+"_chain_"+n.index},globalThis.React.createElement("div",null,n.nodes.map((t,l)=>globalThis.React.createElement(e.Fragment,{key:t.id+"_frag"},globalThis.React.createElement(b,{text:t.title||`Node #${t.id}`}),l<n.nodes.length-1&&globalThis.React.createElement("span",null,"→")))),globalThis.React.createElement("div",null,globalThis.React.createElement("div",null,"Links"),0===n.edges.length?globalThis.React.createElement("div",null,"No BUS edges."):n.edges.map((t,e)=>{var n;return globalThis.React.createElement("div",{key:e},globalThis.React.createElement("span",null,t.from.title||t.from.id," → ",t.to.title||t.to.id),globalThis.React.createElement(b,{text:`id: ${null!=(n=t.linkId)?n:"n/a"}`,kind:t.valid?"ok":"warn"}))})),globalThis.React.createElement("details",null,globalThis.React.createElement("summary",null,"Slots"),n.nodes.map(t=>{var e;return globalThis.React.createElement("div",{key:"slots_"+t.id},globalThis.React.createElement("div",null,t.title||`Node #${t.id}`),0===(null!=(e=n.slotSummaries[t.id])?e:[]).length?globalThis.React.createElement("div",null,"No input slots."):globalThis.React.createElement("div",null,n.slotSummaries[t.id].map(e=>globalThis.React.createElement("div",{key:t.id+"_s_"+e.slot},globalThis.React.createElement(b,{text:`#${e.slot}`}),globalThis.React.createElement(b,{text:e.name||"(unnamed)"}),globalThis.React.createElement(b,{text:e.type||"*"}),globalThis.React.createElement(b,{text:e.linked?"linked":"free",kind:e.linked?"ok":"default"})))))}))))))))}t.innerHTML="",a(t,globalThis.React.createElement(l,null))}});export{R as MaraScottAnyBusNodeExtension,_ as MaraScottAnyBusNodeSidebarTab};
