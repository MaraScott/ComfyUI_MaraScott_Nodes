var e=Object.defineProperty,t=(t,l,a)=>((t,l,a)=>l in t?e(t,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[l]=a)(t,"symbol"!=typeof l?l+"":l,a);import{AnyBusState as l}from"./AnyBus_v2/State.js";import{ALLOWED_GETSET as a,ALLOWED_REROUTE as n,FIRST_INDEX as o,BUS_SLOT as i,ANYBUS_TYPE as s,notifyAnyBusChange as r,hasBusLink as c,getGraphLinkById as d,getConnectedGroupOrNull as m,getBusPaths as u,getActiveGraph as p,collectAnyBusByProfile as g,chainsForProfile as h,busEdgeInfo as f,summarizeSlots as T}from"./AnyBus_v2/Traversal.js";const E=new l;async function y(){if(globalThis.React&&globalThis.ReactDOM)return;const e="extensions/ComfyUI_MaraScott_Nodes/web/assets/js/vendor/react";try{await b(`${e}/react.production.min.js`),await b(`${e}/react-dom.production.min.js`)}catch{await b("https://unpkg.com/react@19.1.1/umd/react.production.min.js"),await b("https://unpkg.com/react-dom@19.1.1/umd/react-dom.production.min.js")}if(!globalThis.React||!globalThis.ReactDOM)throw new Error("React UMD not loaded")}function b(e){return new Promise((t,l)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onload=t,a.onerror=()=>l(new Error("Failed to load "+e)),document.head.appendChild(a)})}function R(e,t){if(!e.__ms_mount){const t=document.createElement("div");(e.attachShadow?e.attachShadow({mode:"open"}):e).appendChild(t),e.__ms_mount={container:t,root:globalThis.ReactDOM.createRoot(t)}}e.__ms_mount.root.render(t)}function v(e){var t,l,a,n,o,i;if(!(null==e?void 0:e.graph)||E.__syncing)return;const s=m(e);if(s){E.__syncing=!0;try{const r=null!=(l=null==(t=e.properties)?void 0:t[_.PROFILE.name])?l:_.PROFILE.default,c=null!=(n=null==(a=e.properties)?void 0:a[_.INPUTS.name])?n:_.INPUTS.default;for(const e of s)_.setValue(e,_.PROFILE.name,r,!0),(null==(o=e.properties)?void 0:o[_.INPUTS.name])!==c&&_.setValue(e,_.INPUTS.name,c,!0);for(const e of s)null==(i=e.setDirtyCanvas)||i.call(e,!0,!0)}finally{E.__syncing=!1}}}function S(e){return"string"==typeof e&&/^\*\s*\d+/.test(e.trim())}function I(e){var t,l,a,n;if(!(null==e?void 0:e.graph))return;const o=m(e);if(!o)return;const i=u(o);if(!i.length)return;const s=Math.max(...o.map(e=>{var t,l;return null!=(l=null==(t=e.properties)?void 0:t[_.INPUTS.name])?l:_.INPUTS.default}));for(let r=P.FIRST_INDEX;r<=s;r++){let e=null;for(const l of i){let a=null,n=null;for(let o=0;o<l.length;o++){const i=null==(t=l[o].inputs)?void 0:t[r];if(i&&(!a&&i.type&&"*"!==i.type?(a=i.type,i.name&&!S(i.name)&&(n=i.name)):a?i.type===a&&i.name&&!S(i.name)&&i.name!==n&&(n=i.name):i.name&&!S(i.name)&&(n=null!=n?n:i.name),a&&n)){const t={type:a,label:n,depth:o};(!e||t.depth>e.depth)&&(e=t)}}}if(e)for(const t of o){const n=null==(l=t.inputs)?void 0:l[r],o=null==(a=t.outputs)?void 0:a[r];n&&o&&(n.name=e.label,"*"!==n.type&&n.type!==e.type||(n.type=e.type),o.name=n.name,o.links&&o.links.length>0&&o.type!==e.type&&"*"!==o.type||(o.type=e.type))}}for(const r of o)null==(n=r.setDirtyCanvas)||n.call(r,!0,!0)}const _={NAMESPACE:"MaraScott",TYPE:"AnyBus_v2",BUS_SLOT:i,FIRST_INDEX:o,ALLOWED_REROUTE_TYPE:n.slice(),ALLOWED_GETSET_TYPE:a.slice(),ALLOWED_NODE_TYPE:[],PROFILE:{name:"profile",default:"default"},INPUTS:{name:"inputs",min:2,max:24,default:2},CLEAN:{name:"Clean Inputs",default:!1},init(e){var t,l;e.properties=e.properties||{},e.properties[this.PROFILE.name]=null!=(t=e.properties[this.PROFILE.name])?t:this.PROFILE.default,e.properties[this.INPUTS.name]=null!=(l=e.properties[this.INPUTS.name])?l:this.INPUTS.default,e.properties.prevProfileName=e.properties[this.PROFILE.name],e.shape=LiteGraph.CARD_SHAPE,e.color=LGraphCanvas.node_colors.green.color,e.bgcolor=LGraphCanvas.node_colors.green.bgcolor,e.groupcolor=LGraphCanvas.node_colors.green.groupcolor,e.size[0]=150,this.updateNodeTitle(e)},updateNodeTitle(e){e.title="AnyBus - "+e.properties[this.PROFILE.name]},getByName(e,t){var l;return null==(l=e.widgets)?void 0:l.find(e=>e.name===t)},setWidgetValue(e,t,l){var a;const n=this.getByName(e,t);n&&(n.value=l,null==(a=e.setDirtyCanvas)||a.call(e,!0,!0))},updateNodeIO(e){if(!e.graph)return;const t=e.properties[this.INPUTS.name],l=(e.inputs||[]).map((t,l)=>{if(null!=(null==t?void 0:t.link)){const a=d(e.graph,t.link);if(a)return{idx:l,link:a}}return null}).filter(Boolean);e.inputs=[],e.outputs=[],e.addInput("bus","BUS"),e.addOutput("bus","BUS");for(let a=1;a<=t;a++){const t=`* ${a.toString().padStart(2,"0")}`.toLowerCase();e.addInput(t,"*"),e.addOutput(t,"*")}l.forEach(({idx:t,link:l})=>{const a=e.graph.getNodeById(l.origin_id);a&&e.connect(t,a,l.origin_slot)}),e.setDirtyCanvas(!0)},setWidgets(e){const t=(t,l)=>{var a;const n=null==(a=e.widgets)?void 0:a.find(e=>e.name===t);n&&(n.value=l)};if(this.getByName(e,this.PROFILE.name)?t(this.PROFILE.name,e.properties[this.PROFILE.name]):e.addWidget("text",this.PROFILE.name,e.properties[this.PROFILE.name],t=>this.setValue(e,this.PROFILE.name,t),{title:"Profile name for this bus"}),this.getByName(e,this.INPUTS.name))t(this.INPUTS.name,e.properties[this.INPUTS.name]);else{const t=Array.from({length:this.INPUTS.max-this.INPUTS.min+1},(e,t)=>t+this.INPUTS.min);e.addWidget("combo",this.INPUTS.name,e.properties[this.INPUTS.name],t=>this.setValue(e,this.INPUTS.name,t),{values:t,title:"Number of input/output pairs"})}this.getByName(e,this.CLEAN.name)||e.addWidget("toggle",this.CLEAN.name,this.CLEAN.default,()=>{try{P.clean(e)}catch(t){}},{title:"Clean and reset all connections"})},setValue(e,t,l,a=!1){var n;const o=e.properties[t];e.properties[t]=l,this.setWidgetValue(e,t,l),t===this.PROFILE.name?(this.updateNodeTitle(e),e.properties.prevProfileName=l):t===this.INPUTS.name&&o!==l&&this.updateNodeIO(e),null==(n=e.setDirtyCanvas)||n.call(e,!0,!0),a||c(e)&&(v(e),I(e)),r()}};_.ALLOWED_NODE_TYPE=[_.NAMESPACE+_.TYPE,..._.ALLOWED_REROUTE_TYPE,..._.ALLOWED_GETSET_TYPE];class P{static connectBus(e,t,l,a){var n,o,i,s,c,d,m;const u=_.PROFILE.name,p=null!=(o=null==(n=e.properties)?void 0:n[u])?o:_.PROFILE.default,g=null!=(s=null==(i=l.properties)?void 0:i[u])?s:_.PROFILE.default;if(p!==_.PROFILE.default&&p!==g)return e.disconnectInput(t),null==(c=e.setDirtyCanvas)||c.call(e,!0,!0),void r();p===_.PROFILE.default&&g!==p&&_.setValue(e,u,g);const h=_.INPUTS.name,f=null!=(m=null==(d=l.properties)?void 0:d[h])?m:_.INPUTS.default;_.setValue(e,h,f),I(e),r()}static connectInput(e,t,l,a){var n,o,i,s;const d=null==(n=l.outputs)?void 0:n[a];if(!d)return;const m=(d.name||"").toLowerCase(),u=d.type||"*";(null==(o=e.inputs)?void 0:o[t])&&(e.inputs[t].name=m||`* ${t.toString().padStart(2,"0")}`,e.inputs[t].type=u,(null==(i=e.outputs)?void 0:i[t])&&(e.outputs[t].name=e.inputs[t].name,e.outputs[t].type=u)),null==(s=e.setDirtyCanvas)||s.call(e,!0,!0),c(e)&&I(e),r()}static disConnectBus(e){var t;null==(t=e.setDirtyCanvas)||t.call(e,!0,!0),r()}static disConnectInput(e,t){var l;null==(l=e.setDirtyCanvas)||l.call(e,!0,!0),r()}static clean(e){var t,l,a,n,o;if(!(null==e?void 0:e.graph))return;let i=!1;if(null!=(null==(l=null==(t=e.inputs)?void 0:t[this.BUS_SLOT])?void 0:l.link)){const t=d(e.graph,e.inputs[this.BUS_SLOT].link);if(t){const l=e.graph.getNodeById(t.origin_id);l&&(e.disconnectInput(this.BUS_SLOT),l.connect(this.BUS_SLOT,e,this.BUS_SLOT),i=!0)}}else for(let s=this.FIRST_INDEX;s<(null!=(n=null==(a=e.inputs)?void 0:a.length)?n:0);s++){const t=e.inputs[s];if(t&&null!=t.link){const l=d(e.graph,t.link);if(l){const t=e.graph.getNodeById(l.origin_id);t&&(e.disconnectInput(s),t.connect(l.origin_slot,e,s),i=!0)}}}if(i){const t=" ... cleaned";e.title=e.title+t,null==(o=e.setDirtyCanvas)||o.call(e,!0,!0),setTimeout(()=>{var l;e.title=e.title.replace(t,""),null==(l=e.setDirtyCanvas)||l.call(e,!0,!0)},500),r()}}}t(P,"TYPE",s),t(P,"BUS_SLOT",i),t(P,"FIRST_INDEX",o);const N="Comfy.MaraScott.AnyBus_v2",w=N.replace(/\./g,"-");function L({text:e,kind:t="default"}){const l="warn"===t?"#f59e0b22":"ok"===t?"#16a34a22":"#6b728022",a="warn"===t?"#f59e0b":"ok"===t?"#16a34a":"#6b7280";return globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("span",{style:{display:"inline-block",padding:"2px 8px",marginRight:6,marginBottom:6,fontSize:12,borderRadius:999,background:l,border:"1px solid "+a}},e))}const k=()=>({name:N,aboutPageBadges:[{label:"Website - MaraScott",url:"https://www.marascott.ai/",icon:"pi pi-home"},{label:"Donate - MaraScott",url:"https://github.com/sponsors/MaraScott",icon:"pi pi-heart"},{label:"GitHub - MaraScott",url:"https://github.com/MaraScott/ComfyUI_MaraScott_Nodes",icon:"pi pi-github"}],bottomPanelTabs:[{id:w,title:"MaraScott Flows",type:"custom",render:async e=>{await y();const t=globalThis.React;function l(){const[e,l]=t.useState({flows:[],total:0,scanned:0}),a=t.useCallback(()=>{const e=p();if(!e)return void l({flows:[],totalFlows:0,nodesCount:0,nodes:[],last:Date.now()});const t=g(e,_.PROFILE.name,_.PROFILE.default),a=Array.from(t.values()).flat().map(e=>{var t,l;return{id:e.id,title:e.title||`Node #${e.id}`,profile:null!=(l=null==(t=e.properties)?void 0:t[_.PROFILE.name])?l:_.PROFILE.default,connected:c(e)}}),n=[];let o=0;for(const[l,i]of t.entries()){const t=h(i).map((t,l)=>{const a=[];for(let o=0;o<t.length-1;o++){const l=f(e,t[o],t[o+1]);a.push({from:t[o],to:t[o+1],linkId:l.id,valid:l.valid})}const n={};for(const e of t)n[e.id]=T(e);return{nodes:t,edges:a,slotSummaries:n,index:l+1}}).filter(e=>e.nodes.length>=2);t.length>0&&(n.push({profile:l,count:t.length,chains:t}),o+=t.length)}l({flows:n,totalFlows:o,nodesCount:a.length,nodes:a,last:Date.now()})},[]);return t.useEffect(()=>{a()},[a]),globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("div",{style:{fontFamily:"sans-serif",fontSize:13,padding:8}},globalThis.React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:8}},globalThis.React.createElement("strong",null,"AnyBus Overview"),globalThis.React.createElement(L,{text:`${e.nodesCount} node(s)`}),globalThis.React.createElement(L,{text:`${e.totalFlows} flow(s)`,kind:e.totalFlows?"ok":"warn"}),globalThis.React.createElement("div",{style:{flex:1}}),globalThis.React.createElement("button",{onClick:a,style:{padding:"2px 8px",cursor:"pointer"}},"Refresh")),globalThis.React.createElement("div",{style:{borderTop:"1px solid #e5e7eb",paddingTop:6,marginTop:6}},globalThis.React.createElement("div",{style:{marginBottom:6}},globalThis.React.createElement("strong",null,"Nodes")," ",globalThis.React.createElement(L,{text:`${e.nodesCount}`})),0===e.nodesCount?globalThis.React.createElement("div",{style:{opacity:.7}},"No AnyBus nodes detected."):globalThis.React.createElement("div",null,e.nodes.map(e=>globalThis.React.createElement("div",{key:e.id,style:{display:"flex",alignItems:"center",gap:6,marginBottom:4,flexWrap:"wrap"}},globalThis.React.createElement(L,{text:e.title}),globalThis.React.createElement(L,{text:`profile: ${e.profile}`}),globalThis.React.createElement(L,{text:e.connected?"connected":"solo",kind:e.connected?"ok":"warn"}))))),globalThis.React.createElement("div",{style:{borderTop:"1px solid #e5e7eb",paddingTop:6,marginTop:6}},globalThis.React.createElement("div",{style:{marginBottom:6}},globalThis.React.createElement("strong",null,"Flows")," ",globalThis.React.createElement(L,{text:`${e.totalFlows}`,kind:e.totalFlows?"ok":"warn"})),0===e.flows.length&&globalThis.React.createElement("div",{style:{opacity:.7}},"No flows yet — connect at least two AnyBus nodes sharing the same profile (or default) via BUS to form a flow."),e.flows.map(e=>globalThis.React.createElement("div",{key:e.profile+"_chain_"+ch.index,style:{padding:"8px 10px",border:"1px solid #e5e7eb",borderRadius:8,marginBottom:8,background:"#f9fafb"}},globalThis.React.createElement("div",{style:{marginBottom:6,overflowX:"auto",whiteSpace:"nowrap"}},ch.nodes.map((e,l)=>globalThis.React.createElement(t.Fragment,{key:e.id+"_frag"},globalThis.React.createElement(L,{text:e.title||`Node #${e.id}`}),l<ch.nodes.length-1&&globalThis.React.createElement("span",{style:{margin:"0 6px"}},"→")))),globalThis.React.createElement("div",{style:{marginBottom:6}},globalThis.React.createElement("div",{style:{fontWeight:600,marginBottom:4}},"Links along the way"),0===ch.edges.length?globalThis.React.createElement("div",{style:{opacity:.7}},"No BUS edges in this chain."):ch.edges.map((e,t)=>{var l;return globalThis.React.createElement("div",{key:t,style:{marginBottom:2}},e.from.title||e.from.id," → ",e.to.title||e.to.id," ",globalThis.React.createElement(L,{text:`bus link: ${null!=(l=e.linkId)?l:"n/a"}`,kind:e.valid?"ok":"warn"}))})),globalThis.React.createElement("details",null,globalThis.React.createElement("summary",{style:{cursor:"pointer",fontWeight:600}},"Slot details (per node)"),ch.nodes.map(e=>{var t;return globalThis.React.createElement("div",{key:"slots_"+e.id,style:{marginTop:6}},globalThis.React.createElement("div",{style:{fontWeight:600}},e.title||`Node #${e.id}`),0===(null!=(t=ch.slotSummaries[e.id])?t:[]).length?globalThis.React.createElement("div",{style:{opacity:.7}},"No input slots."):globalThis.React.createElement("div",null,ch.slotSummaries[e.id].map(t=>globalThis.React.createElement("div",{key:e.id+"_s_"+t.slot,style:{display:"flex",gap:6,alignItems:"center"}},globalThis.React.createElement(L,{text:`#${t.slot}`}),globalThis.React.createElement(L,{text:t.name||"(unnamed)"}),globalThis.React.createElement(L,{text:t.type||"*"}),globalThis.React.createElement(L,{text:t.linked?"linked":"free",kind:t.linked?"ok":"default"})))))})))))))}e.innerHTML="",R(e,globalThis.React.createElement(l,null))}}],async beforeRegisterNodeDef(e,t,l){if(e.comfyClass===_.NAMESPACE+_.TYPE){const t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){_.init(this),_.setWidgets(this),_.updateNodeIO(this),_.setWidgetValue(this,_.PROFILE.name,this.properties[_.PROFILE.name]),_.setWidgetValue(this,_.INPUTS.name,this.properties[_.INPUTS.name]),null==t||t.apply(this,arguments),this.serialize_widgets=!0,E.init=!0};const l=e.prototype.onConnectionsChange;e.prototype.onConnectionsChange=function(e,t,a,n,o){var i,c;if(this.graph){if(E.input.index=t+1-P.FIRST_INDEX,a&&n){const e=this.graph.getNodeById(n.origin_id);e&&(t===P.BUS_SLOT?e.type===s&&n.origin_slot===P.BUS_SLOT?P.connectBus(this,t,e,n.origin_slot):this.disconnectInput(t):P.connectInput(this,t,e,n.origin_slot))}else a||(t===P.BUS_SLOT?P.disConnectBus(this):P.disConnectInput(this,t));t===P.BUS_SLOT&&null!=(null==(c=null==(i=this.inputs)?void 0:i[P.BUS_SLOT])?void 0:c.link)&&v(this),r(),null==l||l.apply(this,arguments)}}}},async setup(){}}),x=()=>({id:w,icon:"mdi mdi-vector-polyline",title:"Any Bus",tooltip:"Any Bus Dashboard",type:"custom",render:async e=>{await y();const t=globalThis.React;function l(){const[e,l]=t.useState({flows:[],totalFlows:0,nodesCount:0,nodes:[],last:0}),a=t.useCallback(()=>{const e=p();if(!e)return void l({flows:[],total:0,scanned:0,last:Date.now()});const t=g(e,_.PROFILE.name,_.PROFILE.default),a=[];let n=0;for(const[l,o]of t.entries()){n+=o.length;const t=h(o).map((t,l)=>{const a=[];for(let o=0;o<t.length-1;o++){const l=f(e,t[o],t[o+1]);a.push({from:t[o],to:t[o+1],linkId:l.id,valid:l.valid})}const n={};for(const e of t)n[e.id]=T(e);return{nodes:t,edges:a,slotSummaries:n,index:l+1}});a.push({profile:l,count:t.length,chains:t})}l({flows:a,total:a.length,scanned:n,last:Date.now()})},[]);return t.useEffect(()=>{const e=()=>a();return window.addEventListener("marascott:anybus:changed",e),()=>window.removeEventListener("marascott:anybus:changed",e)},[a]),globalThis.React.createElement(globalThis.React.Fragment,null,globalThis.React.createElement("div",{style:{fontFamily:"sans-serif",fontSize:12,padding:8}},globalThis.React.createElement("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:8}},globalThis.React.createElement("strong",null,"AnyBus Flows"),globalThis.React.createElement(L,{text:`${e.total} flow(s)`,kind:e.total?"ok":"warn"}),globalThis.React.createElement(L,{text:`${e.scanned} node(s)`}),globalThis.React.createElement("div",{style:{flex:1}}),globalThis.React.createElement("button",{onClick:a,style:{padding:"2px 8px",cursor:"pointer"}},"Refresh")),0===e.flows.length&&globalThis.React.createElement("div",{style:{opacity:.7}},"No AnyBus nodes detected."),e.flows.map(e=>globalThis.React.createElement("details",{key:e.profile,open:!0,style:{borderTop:"1px solid #e5e7eb",paddingTop:6,marginTop:6}},globalThis.React.createElement("summary",{style:{cursor:"pointer"}},globalThis.React.createElement("span",null,"Profile: "),globalThis.React.createElement("strong",null,e.profile)," ",globalThis.React.createElement(L,{text:`${e.count} chain(s)`})),e.chains.map(l=>globalThis.React.createElement("div",{key:e.profile+"_chain_"+l.index,style:{padding:"6px 8px",border:"1px solid #e5e7eb",borderRadius:6,marginBottom:6,background:"#fafafa"}},globalThis.React.createElement("div",{style:{marginBottom:6,overflowX:"auto",whiteSpace:"nowrap"}},l.nodes.map((e,a)=>globalThis.React.createElement(t.Fragment,{key:e.id+"_frag"},globalThis.React.createElement(L,{text:e.title||`Node #${e.id}`}),a<l.nodes.length-1&&globalThis.React.createElement("span",{style:{margin:"0 6px"}},"→")))),globalThis.React.createElement("div",{style:{marginBottom:6}},globalThis.React.createElement("div",{style:{fontWeight:600,marginBottom:2}},"Links"),0===l.edges.length?globalThis.React.createElement("div",{style:{opacity:.7}},"No BUS edges."):l.edges.map((e,t)=>{var l;return globalThis.React.createElement("div",{key:t,style:{display:"flex",alignItems:"center",gap:6}},globalThis.React.createElement("span",null,e.from.title||e.from.id," → ",e.to.title||e.to.id),globalThis.React.createElement(L,{text:`id: ${null!=(l=e.linkId)?l:"n/a"}`,kind:e.valid?"ok":"warn"}))})),globalThis.React.createElement("details",null,globalThis.React.createElement("summary",{style:{cursor:"pointer",fontWeight:600}},"Slots"),l.nodes.map(e=>{var t;return globalThis.React.createElement("div",{key:"slots_"+e.id,style:{marginTop:4}},globalThis.React.createElement("div",{style:{fontWeight:600}},e.title||`Node #${e.id}`),0===(null!=(t=l.slotSummaries[e.id])?t:[]).length?globalThis.React.createElement("div",{style:{opacity:.7}},"No input slots."):globalThis.React.createElement("div",null,l.slotSummaries[e.id].map(t=>globalThis.React.createElement("div",{key:e.id+"_s_"+t.slot,style:{display:"flex",gap:6,alignItems:"center"}},globalThis.React.createElement(L,{text:`#${t.slot}`}),globalThis.React.createElement(L,{text:t.name||"(unnamed)"}),globalThis.React.createElement(L,{text:t.type||"*"}),globalThis.React.createElement(L,{text:t.linked?"linked":"free",kind:t.linked?"ok":"default"})))))}))))))))}e.innerHTML="",R(e,globalThis.React.createElement(l,null))}});export{k as MaraScottAnyBusNodeExtension,x as MaraScottAnyBusNodeSidebarTab};
